<script type="text/x-red" data-template-name="klicktipp-subscription-process-create">
  <div class="form-row">
    <label for="node-input-klicktipp"><i class="fa fa-cog"></i> <span>KlickTipp Config</span></label>
    <input type="text" id="node-input-klicktipp" data-i18n="config node">
  </div>

  <div class="form-row">
    <label for="node-input-subscriptionProcessName"><i class="fa fa-tags"></i> <span>Opt-in process name</span></label>
    <input type="text" id="node-input-subscriptionProcessName" placeholder="Enter name (required)">
    <input type="hidden" id="node-input-subscriptionProcessNameType">
  </div>

  <div class="form-row">
    <label for="node-input-useSingleOptIn"><i class="fa fa-tags"></i> <span>Use single opt-in</span></label>
    <input type="checkbox" id="node-input-useSingleOptIn">
  </div>

  <div class="form-row" id="kt-customPendingConfirmationPage">
    <label for="node-input-customPendingConfirmationPage"><i class="fa fa-tags"></i> <span>Display my own pending confirmation page</span></label>
    <input type="checkbox" id="node-input-customPendingConfirmationPage">
  </div>

  <!-- Hidden form rows for custom pending confirmation page -->
  <div class="form-row" id="node-input-customPendingConfirmationPage-row" style="display:none;">
    <div class="form-row">
      <label for="node-input-customPendingConfirmationPageUrl"><i class="fa fa-tags"></i> <span>URL</span></label>
      <input type="text" id="node-input-customPendingConfirmationPageUrl" placeholder="Enter the URL for your custom confirmation page">
      <input type="hidden" id="node-input-customPendingConfirmationPageUrlType">
    </div>
    <div class="form-row">
      <label for="node-input-customPendingConfirmationPageContactId"><i class="fa fa-tags"></i> <span>Contact ID</span></label>
      <input type="text" id="node-input-customPendingConfirmationPageContactId">
      <input type="hidden" id="node-input-customPendingConfirmationPageContactIdType">
    </div>
    <div class="form-row">
      <label for="node-input-customPendingConfirmationPageEmail"><i class="fa fa-tags"></i> <span>Email</span></label>
      <input type="text" id="node-input-customPendingConfirmationPageEmail">
      <input type="hidden" id="node-input-customPendingConfirmationPageEmailType">
    </div>
    <div class="form-row">
      <label for="node-input-customPendingConfirmationPageContactKey"><i class="fa fa-tags"></i> <span>Contact Key</span></label>
      <input type="text" id="node-input-customPendingConfirmationPageContactKey">
      <input type="hidden" id="node-input-customPendingConfirmationPageContactKeyType">
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-customOptInConfirmationPage"><i class="fa fa-tags"></i> <span>Display my own opt-in confirmation page</span></label>
    <input type="checkbox" id="node-input-customOptInConfirmationPage">
  </div>

  <!-- Hidden form rows for custom opt-in confirmation page -->
  <div class="form-row" id="node-input-customOptInConfirmationPage-row" style="display:none;">
    <div class="form-row">
      <label for="node-input-customOptInConfirmationPageUrl"><i class="fa fa-tags"></i> <span>URL</span></label>
      <input type="text" id="node-input-customOptInConfirmationPageUrl" placeholder="Enter the URL for your custom confirmation page">
      <input type="hidden" id="node-input-customOptInConfirmationPageUrlType">
    </div>
    <div class="form-row">
      <label for="node-input-customOptInConfirmationPageContactId"><i class="fa fa-tags"></i> <span>Contact ID</span></label>
      <input type="text" id="node-input-customOptInConfirmationPageContactId">
      <input type="hidden" id="node-input-customOptInConfirmationPageContactIdType">
    </div>
    <div class="form-row">
      <label for="node-input-customOptInConfirmationPageEmail"><i class="fa fa-tags"></i> <span>Email</span></label>
      <input type="text" id="node-input-customOptInConfirmationPageEmail">
      <input type="hidden" id="node-input-customOptInConfirmationPageEmailType">
    </div>
    <div class="form-row">
      <label for="node-input-customOptInConfirmationPageContactKey"><i class="fa fa-tags"></i> <span>Contact Key</span></label>
      <input type="text" id="node-input-customOptInConfirmationPageContactKey">
      <input type="hidden" id="node-input-customOptInConfirmationPageContactKeyType">
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-useAsChangeEmailList"><i class="fa fa-tags"></i> <span>Use as change email list</span></label>
    <input type="checkbox" id="node-input-useAsChangeEmailList" />
  </div>

  <div class="form-row" id="kt-sendConfirmation">
    <label for="node-input-sendConfirmation"><i class="fa fa-tags"></i> <span>Send confirmation email on every subscription</span></label>
    <input type="checkbox" id="node-input-sendConfirmation">
  </div>

  <div class="form-row" id="kt-pendingContacts">
    <label for="node-input-pendingContacts"><i class="fa fa-tags"></i> <span>Pending contacts</span></label>
    <select id="node-input-pendingContacts">
      <option value="0">Do not delete pending contacts</option>
      <option value="1">Delete pending contacts after 1 day</option>
      <option value="3">Delete pending contacts after 3 days</option>
      <option value="7">Delete pending contacts after 7 days</option>
      <option value="14">Delete pending contacts after 14 days</option>
    </select>
  </div>

  <div class="form-row">
     <label for="node-input-name"><i class="fa fa-tag"></i> <span>Name</span></label>
     <input type="text" id="node-input-name" placeholder="Enter node name">
  </div>
</script>

<script type="text/x-red" data-help-name="klicktipp-subscription-process-create">
  <p>Returns the name of an opt-in process.</p>

  <h3>Inputs</h3>
  <dl class="message-properties">
    <dt>msg.payload<span class="property-type">object</span></dt>
    <dd>
       Expected object with the following properties:
       <ul>
           <li><code>listId</code> - (Required) the ID of an opt-in process</li>
       </ul>
    </dd>
  </dl>

  <h3>Outputs</h3>
  <dl class="message-properties">
      <dt>msg.payload <span class="property-type">object</span></dt>
      <dd>
          On success:
          <ul>
              <li>An object representing the opt-in process.</li>
          </ul>
      </dd>
      <dd>
          On failure:
          <ul>
              <li><code>{ success: false }</code></li>
          </ul>
      </dd>

      <dt>msg.error <span class="property-type">string</span></dt>
      <dd>An error message explaining why the request failed.</dd>
  </dl>

  <h3>Node Status</h3>
  <ul>
     <li><strong>Green (dot)</strong> - Opt-in processes fetched successfully.</li>
     <li><strong>Red (ring)</strong> - Failed to fetch opt-in processes due to an error.</li>
  </ul>
</script>

<script type="text/javascript">
  RED.nodes.registerType('klicktipp-subscription-process-create', {
    category: 'KlickTipp',
    color: '#DAE1FC',
    defaults: {
      klicktipp: {
        type: 'klicktipp-config',
        required: true
      },
      subscriptionProcessName: {
        value: 'payload.name',
        validate: RED.validators.typedInput('subscriptionProcessNameType')
      },
      subscriptionProcessNameType: {
        value: 'msg'
      },

      useSingleOptIn: {
        value: false
      },

      customPendingConfirmationPage: {
        value: false,
      },

      customOptInConfirmationPage: {
        value: false
      },

      // Custom Opt-in Confirmation Page fields
      customOptInConfirmationPageUrl: {
        value: 'payload.confirmationPageUrl',
        validate: RED.validators.typedInput('customOptInConfirmationPageUrlType')
      },
      customOptInConfirmationPageUrlType: { value: 'msg' },

      customOptInConfirmationPageContactId: {
        value: 'payload.confirmationPageContactId',
        validate: RED.validators.typedInput('customOptInConfirmationPageContactIdType')
      },
      customOptInConfirmationPageContactIdType: { value: 'msg' },

      customOptInConfirmationPageEmail: {
        value: 'payload.confirmationPageEmail',
        validate: RED.validators.typedInput('customOptInConfirmationPageEmailType')
      },
      customOptInConfirmationPageEmailType: { value: 'msg' },

      customOptInConfirmationPageContactKey: {
        value: 'payload.confirmationPageContactKey',
        validate: RED.validators.typedInput('customOptInConfirmationPageContactKeyType')
      },
      customOptInConfirmationPageContactKeyType: { value: 'msg' },

      // Custom Pending Confirmation Page fields
      customPendingConfirmationPageUrl: {
        value: 'payload.pendingConfirmationPageUrl',
        validate: RED.validators.typedInput('customPendingConfirmationPageUrlType')
      },
      customPendingConfirmationPageUrlType: { value: 'msg' },

      customPendingConfirmationPageContactId: {
        value: 'payload.pendingConfirmationPageContactId',
        validate: RED.validators.typedInput('customPendingConfirmationPageContactIdType')
      },
      customPendingConfirmationPageContactIdType: { value: 'msg' },

      customPendingConfirmationPageEmail: {
        value: 'payload.pendingConfirmationPageEmail',
        validate: RED.validators.typedInput('customPendingConfirmationPageEmailType')
      },
      customPendingConfirmationPageEmailType: { value: 'msg' },

      customPendingConfirmationPageContactKey: {
        value: 'payload.pendingConfirmationPageContactKey',
        validate: RED.validators.typedInput('customPendingConfirmationPageContactKeyType')
      },
      customPendingConfirmationPageContactKeyType: { value: 'msg' },

      useAsChangeEmailList: {
        value: false
      },

      pendingContacts: {
        value: 0
      }
    },
    inputs: 1,
    outputs: 1,
    icon: 'klicktipp.svg',
    label: function () {
      return this.name || 'Opt-in process create';
    },
    labelStyle: "klicktipp_label_style",
    paletteLabel: 'Opt–in process create',

    onadd: function() {
      ktPopulateConfig(this);
    },

    oneditprepare: function() {
      const klicktippInput = $('#node-input-klicktipp');
      const listIdDropdown = $('#node-input-listId');
      const $singleOptInCheckbox = $('#node-input-useSingleOptIn');
      const $customOptInCheckbox = $('#node-input-customOptInConfirmationPage');
      const $customPendingConfirmationCheckbox = $('#node-input-customPendingConfirmationPage');
      const $customOptInSection = $('#node-input-customOptInConfirmationPage-row');
      const $customPendingConfirmationSection = $('#node-input-customPendingConfirmationPage-row');
      const $sendConfirmationSection = $('#kt-sendConfirmation');
      const $pendingContactsSection = $('#kt-pendingContacts');
      const $pendingConfirmationPageSection = $('#kt-customPendingConfirmationPage');

      ktBindDropdownToInput(klicktippInput, listIdDropdown, this.listId, this.klicktipp, `/klicktipp/subscription-processes/${this.id}`);

      // Initialize typed inputs
      ktInitializeTypedInput("#node-input-customOptInConfirmationPageUrl", "#node-input-customOptInConfirmationPageUrlType", 'str', ['str']);
      ktInitializeTypedInput("#node-input-customOptInConfirmationPageContactId", "#node-input-customOptInConfirmationPageContactIdType", 'str', ['str']);
      ktInitializeTypedInput("#node-input-customOptInConfirmationPageEmail", "#node-input-customOptInConfirmationPageEmailType", 'str', ['str']);
      ktInitializeTypedInput("#node-input-customOptInConfirmationPageContactKey", "#node-input-customOptInConfirmationPageContactKeyType", 'str', ['str']);

      ktInitializeTypedInput("#node-input-customPendingConfirmationPageUrl", "#node-input-customPendingConfirmationPageUrlType", 'str', ['str']);
      ktInitializeTypedInput("#node-input-customPendingConfirmationPageContactId", "#node-input-customPendingConfirmationPageContactIdType", 'str', ['str']);
      ktInitializeTypedInput("#node-input-customPendingConfirmationPageEmail", "#node-input-customPendingConfirmationPageEmailType", 'str', ['str']);
      ktInitializeTypedInput("#node-input-customPendingConfirmationPageContactKey", "#node-input-customPendingConfirmationPageContactKeyType", 'str', ['str']);

      // Toggle functions
      function toggleCustomOptInSection() {
        $customOptInSection.toggle($customOptInCheckbox.is(':checked'));
      }

      function toggleCustomPendingConfirmationSection() {
        $customPendingConfirmationSection.toggle($customPendingConfirmationCheckbox.is(':checked'));
      }

      function toggleSingleOptInDependencies() {
        const isSingleOptIn = $singleOptInCheckbox.is(':checked');
        $sendConfirmationSection.toggle(!isSingleOptIn);
        $pendingContactsSection.toggle(!isSingleOptIn);
        $pendingConfirmationPageSection.toggle(!isSingleOptIn);
        if (isSingleOptIn) {
          $customPendingConfirmationSection.hide();
        } else {
          // If previously checked, restore the state
          toggleCustomPendingConfirmationSection();
        }
      }

      // Initial states
      toggleCustomOptInSection();
      toggleCustomPendingConfirmationSection();
      toggleSingleOptInDependencies();

      // Event listeners for checkboxes
      $customOptInCheckbox.on('change', toggleCustomOptInSection);
      $customPendingConfirmationCheckbox.on('change', toggleCustomPendingConfirmationSection);
      $singleOptInCheckbox.on('change', toggleSingleOptInDependencies);
    },
  });
</script>
