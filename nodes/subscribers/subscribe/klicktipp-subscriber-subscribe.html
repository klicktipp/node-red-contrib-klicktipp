<script type="text/x-red" data-template-name="klicktipp-subscriber-subscribe">
	<div class="form-row">
		<label for="node-input-klicktipp"><i class="fa fa-cog"></i> <span data-i18n="klicktipp-subscriber-subscribe.label.config"></span></label>
	    <input type="text" id="node-input-klicktipp">
	</div>
	<div class="form-row">
	    <label for="node-input-email"><i class="fa fa-envelope"></i> <span data-i18n="klicktipp-subscriber-subscribe.label.email"></span></label>
	    <input type="text" id="node-input-email" data-i18n="[placeholder]klicktipp-subscriber-subscribe.placeholder.email">
	    <input type="hidden" id="node-input-emailType">
	</div>
	<div class="form-row">
		<label for="node-input-smsNumber"><i class="fa fa-mobile"></i> <span data-i18n="klicktipp-subscriber-subscribe.label.sms-number"></span></label>
		<input type="text" id="node-input-smsNumber" data-i18n="[placeholder]klicktipp-subscriber-subscribe.placeholder.sms-number">
		<input type="hidden" id="node-input-smsNumberType">
	</div>
	<div class="form-row">
        <label for="node-input-listId"><i class="fa fa-tags""></i> <span data-i18n="klicktipp-subscriber-subscribe.label.subscription-process"></span></label>
        <select id="node-input-listId"></select>
    </div>
    <div class="form-row">
        <label for="node-input-tagId"><i class="fa fa-tag"></i> <span data-i18n="klicktipp-subscriber-subscribe.label.tag"></span></label>
        <select id="node-input-tagId"></select>
    </div>
	<div class="form-row">
	    <label for="node-input-fields"><i class="fa fa-list"></i> <span data-i18n="klicktipp-subscriber-subscribe.label.fields"></span></label>
	    <input type="text" id="node-input-fields" data-i18n="[placeholder]klicktipp-subscriber-subscribe.placeholder.fields">
	    <input type="hidden" id="node-input-fieldsType">
	</div>
	<div id="contact-fields-section" class="form-row" style="display: none"></div>
	<div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="klicktipp-subscriber-subscribe.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]klicktipp-subscriber-subscribe.placeholder.name">
	</div>
</script>

<script type="text/javascript">
	RED.nodes.registerType('klicktipp-subscriber-subscribe', {
		category: 'KlickTipp',
		color: '#DAE1FC',
		defaults: {
			klicktipp: { type: 'klicktipp-config', required: true },
			email: {
				value: 'payload.email',
				validate: RED.validators.typedInput('emailType')
			},
			emailType: {
				value: 'msg'
			},
			smsNumber: {
				value: 'payload.smsNumber',
				validate: RED.validators.typedInput('smsNumberType')
			},
			smsNumberType: {
				value: 'msg'
			},
			listId: {
				value: '',
				validate: function(value) {
					return value === '' || RED.validators.number()(value); // Allows empty value
				}
			},
			tagId: {
				value: '',
				validate: function(value) {
					return value === '' || RED.validators.number()(value); // Allows empty value
				}
			},
			fields: {
				value: 'payload.fields',
				validate: function(v) {
					// Allow empty values
					return (v === '' || v === undefined || RED.validators.typedInput('fieldsType')(v));
				}
			},
			fieldsType: {
				value: 'msg'
			},
			fieldsData: {
				value: {}
			},
			name: {
				value: ''
			},
		},
		inputs: 1,
		outputs: 1,
		icon: 'klicktipp.svg',
		label: function () {
			return this.name || this._("klicktipp-subscriber-subscribe.name");
		},
		labelStyle: "klicktipp_label_style",
		paletteLabel: function () {
			return this._("klicktipp-subscriber-subscribe.name");
		},
		onadd: function() {
			ktPopulateConfig(this);
		},
		oneditprepare: function() {
			const klicktippInput = $('#node-input-klicktipp');
			const fieldsInput = $('#node-input-fields');

			this.tagDropdown = $('#node-input-tagId');
			this.listIdDropdown = $('#node-input-listId');
			this.contactFieldsSection = $('#contact-fields-section');

			const i18nStrings = {
				noValidItemsError: this._('klicktipp-subscriber-subscribe.error.no-valid-items-found'),
				placeholderOption: this._("klicktipp-subscriber-subscribe.label.select-option"),
				errorNoValidItems: this._("klicktipp-subscriber-subscribe.error.no-valid-items-found"),
				errorPrefix: this._("klicktipp-subscriber-subscribe.error.prefix"),
				dropdownPlaceholderText: this._("klicktipp-subscriber-subscribe.placeholder.custom-field-dropdown"),
				addCustomFieldLabelText: this._("klicktipp-subscriber-subscribe.label.add-custom-field"),
				customFieldsListLabel: this._("klicktipp-subscriber-subscribe.label.data-fields-list"),
				customFieldOptional: this._("klicktipp-subscriber-subscribe.placeholder.custom-field-optional"),
				customFieldEnter: this._("klicktipp-subscriber-subscribe.placeholder.custom-field-enter"),
			};

			setKlicktippI18n(i18nStrings);

			// Initialize typed inputs
			ktInitializeTypedInput(
					'#node-input-email',
					'#node-input-emailType',
					'str',
					['str']
			);
			ktInitializeTypedInput(
					'#node-input-smsNumber',
					'#node-input-smsNumberType',
					'str',
					['str']
			);
			ktInitializeTypedInput(
					'#node-input-fields',
					'#node-input-fieldsType',
					'msg',
					['json', getKTCustomContactFieldsType()]
			);

			// Bind dropdowns for tags and lists
			ktBindDropdownToInput(
					klicktippInput,
					this.tagDropdown,
					this.tagId,
					this.klicktipp,
					`/klicktipp/tags/${this.id}`
			);

			ktBindDropdownToInput(
					klicktippInput,
					this.listIdDropdown,
					this.listId,
					this.klicktipp,
					`/klicktipp/subscription-processes/${this.id}`
			);

			// Initialize the contact fields section logic
			ktInitializeContactFieldsSection(
					fieldsInput,
					this.contactFieldsSection,
					klicktippInput,
					this.fieldsData,
					this.id
			);

			// Initialize the select handler with user change detection
			ktInitializeUserSelectHandler(
					klicktippInput,
					'#node-input-fieldsType',
					this.contactFieldsSection,
					this.fieldsData,
					this.id
			);

		},
		oneditsave: function() {
			// Use the previously set common variables
			this.tagId = Number(this.tagDropdown.val()); // Save the selected tagId
			this.listId = Number(this.listIdDropdown.val()); // Save the selected listId

			// Collect all field from API vales and store them in this.fieldsData
			this.fieldsData = ktSaveContactFieldValues(this.contactFieldsSection);
		}
	});
</script>
